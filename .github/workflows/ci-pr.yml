---
name: CI PR

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  syntax:
    name: Syntax & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            max-jobs = auto
            cores = 0

      - uses: actions/cache@v4
        with:
          path: ~/.cache/nix
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: nix-${{ runner.os }}-

      - name: Flake check
        run: nix flake check --no-build

      - name: Flake show
        run: nix flake show

      - name: Deadnix
        continue-on-error: true
        run: |
          nix shell nixpkgs#deadnix --command deadnix --exclude result

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Gitleaks
        continue-on-error: true
        run: |
          nix shell nixpkgs#gitleaks --command \
            gitleaks detect --source . --report-path gitleaks-report.json || true

      - name: Trivy
        continue-on-error: true
        run: |
          nix shell nixpkgs#trivy --command \
            trivy fs --severity CRITICAL,HIGH --exit-code 0 .

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: gitleaks-report.json
          if-no-files-found: ignore
          retention-days: 30

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [syntax, security]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Check syntax result
        run: |
          if [ "${{ needs.syntax.result }}" != "success" ]; then
            echo "Syntax validation failed"
            exit 1
          fi

      - name: Post PR comment
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        env:
          SYNTAX_RESULT: ${{ needs.syntax.result }}
          SECURITY_RESULT: ${{ needs.security.result }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const syntaxOk = process.env.SYNTAX_RESULT === 'success';
            const securityOk = process.env.SECURITY_RESULT === 'success';

            const body = `## CI Results\n\n- Syntax & Lint: ${syntaxOk ? 'Pass' : 'Fail'}\n- Security Scan: ${securityOk ? 'Pass' : 'Review findings'}\n\nReady to merge: ${syntaxOk ? 'Yes' : 'No - fix syntax errors first'}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            }).catch(err => console.log('Comment failed:', err.message));
